---
title: "Niche-phenotype mapping in TNBC MIBI data"
author: "Anissa El Marrahi"
date: "4/7/2022"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

TMENs are 4 local niches that might explain inter-patient variability in tumor microenvionment cellular composition as a continuum. We previously showed that they help bridging micro (cells neighborhood) and macroscopic tumor architecture (CyTOF experiment on 5x5x5 mm tumors) on breast cancer samples.
TMENs were proved to be a a simple framework to study tumor architecture and accurate in the sense that it can retrieve the original tumor cell composition.

However, we still lack a quantitative framework to analyze the TME in a higher level of abstraction: cell phenotypes <--> cell markers expression. We know that for example, there is high variability in immune response of TILs (pro/anti-inflammation) within the tumor microenvironment. It is relevant to study how the environment impacts the differential expression of different markers at the single-cell level. However, a spatial coarse-grained approach is hard to tackle. The need for a simplified framework to study this question grows as the level of accuracy in the exploration of the tumor microenvironment increases. Therefore, it is legitimate to assess the relevance of TMENs as a framework to explore the phenotypical diversity of cells within the TME.

Are cell phenotypes driven by the environment in TNBC ?
To address this, we will study the local environment at the single-cell level. Instead of having cell positions (x,y), the local environment will be described as a vector \alpha with the proportions of TMENs of a site centered on each cell. We will study then the expression of specific markers of interest within specific cell types in function of \alpha. 

## Loading libraries and data

```{r libs}
gc()
rm(list=ls())
library(tidyverse)
library(plotly)
#library(reticulate)
library(ade4)
library(htmltools)
library(factoextra)
library('Ternary')
library(pheatmap)
source("./functions_phenotypes_tmens.r")
dirName <- dirname(rstudioapi::getSourceEditorContext()$path )
setwd(dirName)#setwd(dir = "/scratch/anissa.el/ImmuneStates/phenot_tmens")

```

### Constant variables

```{r constants}

CELLTYPES <- c('CD8-T', 'Other immune', 'DC / Mono', 'CD3-T', 'B', 'NK', 'Keratin-positive tumor', 'Tumor','CD4-T', 'Mesenchymal-like', 'Macrophages', 'Endothelial', 'Tregs', 'DC', 'Mono / Neu','Neutrophils')## Removed Unidentified cells
NBCELLTYPES = length(CELLTYPES)
MARKERS <- c("dsDNA","Vimentin","SMA","B7H3","FoxP3","Lag3","CD4","CD16","CD56","OX40","PD1","CD31","PD.L1","EGFR","Ki67","CD209","CD11c","CD138","CD163","CD68","CSF.1R","CD8","CD3","IDO","Keratin17","CD63","CD45RO","CD20","p53","Beta.catenin","HLA.DR","CD11b","CD45","H3K9ac","Pan.Keratin","H3K27me3","phospho.S6","MPO","Keratin6","HLA_Class_1")

```

### Sites and TMENs data

```{r data, echo=TRUE}
##CSV file of archetypes found by archetype analysis and their cell composition
archsToTMENs <- read.csv("../TMENS_analysis/output/archetypes_building_blocks_17cells_space_gaussian.csv")
# ARCH1: TLS
# ARCH2: INFLAMMATORY NICHE
# ARCH3: CANCER NICHE
# ARCH4: FIBROTIC/NECROTIC NICHE

## .csv file containing the expression of markers from all cells from all images
cell_markers <- read.csv('../TMENS_analysis/data/cellData.csv',header = TRUE, sep =',')

#colnames(cell_markers)
cell_markers <- cell_markers %>% relocate(Background, .after = cellLabelInImage)
cell_markers <- dplyr::select(cell_markers,-(cellSize:Fe))
#SampleID,cellLabelInImage,cell_markers,Pan.Keratin,Keratin6,Keratin17,p53,Beta.catenin,EGFR,
#                        dsDNA,H3K9ac,H3K27me3,phospho.S6,Ki67,
#                        CD45,CD3,CD8,CD4,FoxP3,CD20,CD45RO,CD56,CD16,CD138,CD11b,CD11c,CD68,CD63,MPO,HLA.DR,HLA_Class_1,CD209,
#                        Lag3,PD1,PD.L1,IDO,
#                        Vimentin,SMA,CD31,
#                        B7H3,OX40,CD163,CSF.1R,tumorYN,tumorCluster,Group,immuneGroup

cell_markers <- dplyr::select(cell_markers,-c( immuneCluster, Ta, Au))%>% 
  mutate(immuneGroup = recode(immuneGroup,`0`= 'None',`1`='Tregs', `2`='CD4-T',
                              `3`='CD8-T', `4`='CD3-T', `5`='NK',
                    `6`='B', `7`='Neutrophils', `8`='Macrophages', `9`='DC',
                    `10`='DC / Mono', `11`='Mono / Neu', `12`='Other immune')) %>% 
  mutate(Group = recode(Group,`1`='Unidentified', `2`='Immune',
                        `3`='Endothelial', `4`='Mesenchymal-like',
                        `5` = 'Tumor',
                        `6` = 'Keratin-positive tumor'))

cell_markers <- cell_markers%>%
  mutate(cell_type = ifelse(Group == 'Immune', cell_type<- immuneGroup,cell_type <- Group))%>%
  dplyr::select(-(tumorYN:immuneGroup))%>%filter(cell_type!="Unidentified")

cell_markers <- cell_markers%>%
  dplyr::rename(patient_id = SampleID)%>%
  dplyr::rename(cell_id = cellLabelInImage)%>%
  mutate(H3K9ac_H3K27me3 = H3K9ac/H3K27me3)
#colnames(cell_markers)

#### Select functional markers
##.csv file containing the markers and their use in MIBI (lineage, function)
stateMarkers <- read.csv("./data/proteins_by_frame.csv")
FuncMarkers <- stateMarkers%>%filter(Purpose =="Functional")%>%pull(Biomarker)

FuncMarkers <- append(str_replace_all(FuncMarkers,c("HLA-DR"="HLA.DR","PD-L1" = "PD.L1","phospho-S6" = "phospho.S6","Beta catenin" = "Beta.catenin")),"H3K9ac_H3K27me3")

```




#### Hierarchical clustering of cell types by functional markers

```{r hclustCT,eval=TRUE}
library(cluster)

colsToKeep <- append(append(FuncMarkers,"cell_type"),"cell_id")
CellsFunctMarkers.df <- cell_markers[which(cell_markers$cell_type %in% c("DC")),append(colsToKeep,"patient_id")]
#%>%mutate(id = paste0(cell_type,"_",cell_id))%>%column_to_rownames(var="id")#%>%group_by(cell_type) c("DC", "Keratin-positive tumor", "NK", "Neutrophils", "Tregs")
rownames(CellsFunctMarkers.df) <- make.names(paste0(CellsFunctMarkers.df$cell_type,"_",CellsFunctMarkers.df$cell_id,"_",CellsFunctMarkers.df$patient_id),unique=TRUE)
#cells.markers <- group_split(CellsFunctMarkers.df )


## Scale the values of intensity markers for each cluster
ZscoreScale <- function(M, cutOff=3) {
  M0 = apply(M, 2, function(x) {(x-mean(x)) / sd(x)}) %>% t
  M0[M0>cutOff] = cutOff
  M0[M0<(-cutOff)] = -cutOff
  return(M0)
}
#list_heatmap <- lapply(cells.markers, FUN = function(x) pheatmap(as.matrix(x%>%dplyr::select(-(cell_type)))))

### Apply Z-score scaling marker-wise and compute mean(Z-score) 
# Apply hclustering using Ward's linkaage method
cm.mat <- CellsFunctMarkers.df%>%dplyr::select(-c(cell_type,cell_id,patient_id))%>%ZscoreScale()%>%t()
CM.dist <- dist(cm.mat,method="euclidian")
clust.DC <- hclust(CM.dist,method = "ward.D")
sub_grp <-  data.frame(cell_id=names(cutree(clust.DC, k = 10)),cluster=cutree(clust.DC, k = 10),row.names=NULL)
#cm.mat[,'cluster'] <- sub_grp

## Group by marker and apply mean(Z-score) for each cell type
clustMarkers.zscore <- cm.mat %>%as_tibble(rownames=NA)%>%rownames_to_column(var="cell_id")%>%
  left_join(.,sub_grp, by="cell_id")%>%
  pivot_longer(cols = FuncMarkers, names_to="marker",values_to = "value")%>%
  group_by(cluster,marker)%>%
  mutate(meanMClust = mean(value))%>%
  distinct(cluster,marker,meanMClust)%>%
  pivot_wider( names_from='marker',values_from = "meanMClust")%>%column_to_rownames(var="cluster")

pheatmap(as.matrix(clustMarkers.zscore),cluster_cols = FALSE,cluster_rows = FALSE)

#pheatmap(as.matrix(CellsFunctMarkers.df), cluster_cols = FALSE)
#fviz_cluster(list(data = CellsFunctMarkers.df%>%dplyr::select(-(cell_type)), cluster = sub_grp))
##pheatmap(as.matrix(CellsFunctMarkers.df%>%dplyr::select(-c(cell_type,cell_id))%>%t%>%scale()),cellheight= 15,show_colnames = FALSE)
#plot(clust.DC)

## Hierarchical clustering on cells from the same type, ward's method (variance minimization, scaled with cut-off value of markers intensity =3)
hclust_cellTypes <- function(){
  
  CellsFunctMarkers.df <- cell_markers[which(cell_markers$cell_type %in% c("DC", "NK", "Neutrophils", "Tregs","Macrophages")),append(append(append(all_of(FuncMarkers),"cell_type"),"cell_id"),"patient_id")]# "Keratin-positive tumor"
  
  rownames(CellsFunctMarkers.df) <- make.names(paste0(CellsFunctMarkers.df$cell_type,"_",CellsFunctMarkers.df$cell_id,"_",CellsFunctMarkers.df$patient_id),unique=TRUE)
  #print(rownames(CellsFunctMarkers.df))
  cells.markers <- group_split(CellsFunctMarkers.df%>%rownames_to_column(var="id")%>%group_by(cell_type))
  #print(cells.markers)
  
  list_heatmaps <- lapply(cells.markers, FUN = function(x) {
    #print(unique(x$cell_type))
    ct <- unique(x$cell_type)
    print(ct)
    x <- x%>%column_to_rownames(var="id")
    cm.mat <- x%>%dplyr::select(-c(cell_type,cell_id,patient_id))%>%ZscoreScale()%>%t()
    print(dim(cm.mat))
    #print(rownames(x))
    CM.dist <- dist(cm.mat,method="euclidian")
    Cells.hclust <- hclust(CM.dist,method = "ward.D")
    #print(table(cutree(Cells.hclust, k = 10)))
    ##Cluster ids assigned to each cell
    sub_grp <-  data.frame(cell_id=rownames(x),cluster=cutree(Cells.hclust, k =10),row.names=NULL)#(cell_id=seq(1,nrow(x),1),cluster=cutree(Cells.hclust, k = 10),row.names=NULL)
    #cm.mat[,'cluster'] <- sub_grp
    write_csv(sub_grp%>%separate(cell_id,into=c("cell_type","label","SampleID"),sep="_"),paste0("./outputs/",ct,"_hclustIDs.csv"))
    clustMarkers.zscore <- cm.mat %>%as_tibble()%>%mutate(cell_id=rownames(x))%>%#as_tibble(rownames=NA)%>%rownames_to_column(var="cell_id")%>%
      left_join(.,sub_grp, by="cell_id")%>%
      pivot_longer(cols = FuncMarkers, names_to="marker",values_to = "value")%>%
      group_by(cluster,marker)%>%
      mutate(meanMClust = mean(value))%>%
      distinct(cluster,marker,meanMClust)%>%
      arrange(marker)%>%
      pivot_wider( names_from='marker',values_from = "meanMClust")%>%column_to_rownames(var="cluster")
    pdf(paste0("./figs/",ct,"cells_clusters.pdf"),width=6.5,height=5)
    pheatmap(as.matrix(clustMarkers.zscore%>%t()),cluster_cols = FALSE,cluster_rows = FALSE,main=ct,cell_width=1.5,cell_height = 2)
    dev.off()
  })
  return(list_heatmaps)
}

hclust_cellTypes()


```



```{r tmensCells}
#use read_csv and write_rds
#tmens_cells <- read.csv("../data_BB/archetypes_sites_centered_cells_gaussian.csv")%>%filter(cell_type_site!="Unidentified")#remove Unidentified cells from analysis  archetypes_sites_centered_cells_gaussian.csv

##.csv file containing the TMENs proportion of cells
tmens_cells2 <- read.csv("../TMENS_analysis/output/archetypes_sites_centered_cells_gaussian2.csv")%>%filter(cell_type_site!="Unidentified")
#rowSums(tmens_cells[,c("archetype1","archetype2","archetype3","archetype4")])

```


## Selection of markers/cell types of interest

```{r selectMarkers, echo=TRUE}

markersPerCell <- cell_markers%>%pivot_longer(cols = c("dsDNA","Background","Vimentin","SMA","B7H3","FoxP3","Lag3","CD4","CD16","CD56","OX40","PD1","CD31","PD.L1","EGFR","Ki67","CD209","CD11c","CD138","CD163","CD68","CSF.1R","CD8","CD3","IDO","Keratin17","CD63","CD45RO","CD20","p53","Beta.catenin","HLA.DR","CD11b","CD45","H3K9ac","Pan.Keratin","H3K27me3","phospho.S6","MPO","Keratin6","HLA_Class_1","H3K9ac_H3K27me3"),names_to = "marker", values_to= "value")
markersPerCell.sd <- markersPerCell%>% group_by(cell_type, marker)%>%summarise(sd = sd(value))

#MarkersCells.var <- left_join(selectedMarkers, markersPerCell,by= c("cell_type","marker"))

# ggplot(data = markersPerCell.sd ,aes(x=cell_type,y = sd,group = marker))+
#   geom_point()+#scale_y_log10()+geom_boxplot()+
#   geom_hline(yintercept=2, linetype="dashed", color = "red")+
#   theme(axis.text.x = element_text(angle = 90, hjust = 0.2, vjust = 0.2))+
#   labs(x = "")

#selectedMarkers <- markersPerCell.sd%>%filter(sd >=2)#%>%ungroup()%>%dplyr::select(marker)%>%unique()
#saveRDS(selectedMarkers,"./selected_markers_cells.rds")

```

```{r eval=FALSE,CMdensity}

sitesCellsCM <- left_join(markersPerCell%>%rename(site_id=cell_id),tmens_cells2, by=c("patient_id","site_id"))%>%filter(!is.na(cell_type_site))

ggplot(sitesCellsCM%>%filter(marker=='Keratin6'),aes(x=TOT_cell_dens,y=value))+
  geom_point(alpha=.02)+
  geom_density_2d()
  #stat_cor(method="spearman",cor.coef.name="rho",label.x=0.015,label.y=6)

ggplot(sitesCellsCM%>%filter(marker=='Keratin6'),aes(y=value, group=cell_type,fill=cell_type))+
  geom_boxplot()

ggplot(sitesCellsCM%>%filter(marker=='Beta.catenin'),aes(x=TOT_cell_dens,y=value))+
  geom_point(alpha=.02)+
  geom_density_2d()

```


## TMENS as a new way to describe single-cell local environment 

```{r tmens, echo=TRUE}
#MarkersCells.var <- left_join(selectedMarkers, markersPerCell,by= c("cell_type","marker"))
### Markers expr for all cell types from all sites
if (file.exists("./outputs/MarkersCellsTMENs.rds")){
  MarkersCellsTMENS <- readRDS("./outputs/MarkersCellsTMENs.rds")
}else{
  MarkersCellsTMENS <- left_join(markersPerCell%>%rename(site_id=cell_id),tmens_cells2, by=c("patient_id","site_id"))%>%filter(!(is.na(arch1)| is.na(arch2)| is.na(arch3) | is.na(arch4)))%>%
  mutate(a1a2 = arch1*arch2)%>%
  mutate(a1a3 = arch1*arch3)%>%
  mutate(a1a4 = arch1*arch4)%>%
  mutate(a2a3 = arch2*arch3)%>%
  mutate(a2a4 = arch2*arch4)%>%
  mutate(a3a4 = arch3*arch4)%>%
  mutate(a1a2a3 = arch1*arch2*arch3)%>%
  mutate(a1a2a4 = arch1*arch2*arch4)%>%
  mutate(a1a3a4 = arch1*arch3*arch4)%>%
  mutate(a2a3a4 = arch2*arch3*arch4)%>%
  mutate(a1a2a3a4 = arch1*arch2*arch3*arch4)
  

  saveRDS(MarkersCellsTMENS,"./outputs/MarkersCellsTMENs.rds")
}

MarkersCellsTMENS2 <- left_join(markersPerCell%>%rename(site_id=cell_id),tmens_cells2, by=c("patient_id","site_id"))%>%filter(!(is.na(arch1)| is.na(arch2)| is.na(arch3) | is.na(arch4)))%>%
  mutate(a1a2 = arch1*arch2)%>%
  mutate(a1a3 = arch1*arch3)%>%
  mutate(a1a4 = arch1*arch4)%>%
  mutate(a2a3 = arch2*arch3)%>%
  mutate(a2a4 = arch2*arch4)%>%
  mutate(a3a4 = arch3*arch4)%>%
  mutate(a1a2a3 = arch1*arch2*arch3)%>%
  mutate(a1a2a4 = arch1*arch2*arch4)%>%
  mutate(a1a3a4 = arch1*arch3*arch4)%>%
  mutate(a2a3a4 = arch2*arch3*arch4)%>%
  mutate(a1a2a3a4 = arch1*arch2*arch3*arch4)
#### Only highly variable markers expr from selected cell types across patients/sites

#MarkersCellsTMENS.selected <- left_join(selectedMarkers,MarkersCellsTMENS,by=c("cell_type","marker"))#left_join(MarkersCells.var%>%rename(site_id=cell_id),tmens_cells, by=c("patient_id","site_id"))
#saveRDS(MarkersCellsTMENS,"./markers_cells_tmens.rds")

```

Plot the proportions of TMENs and show the intensity of the marker for cell type


```{r plotNeutrPDL1, eval=FALSE}
library(ggpubr)

MarkersCellsTMENS1 <- MarkersCellsTMENS%>%dplyr::rename(TLS=arch1)%>%
  dplyr::rename(inflamm = arch2)%>%dplyr::rename(fibrotic=arch4)%>%
  dplyr::rename(cancer=arch3)

MarkersCellsTMENS.reduc <- MarkersCellsTMENS2%>%dplyr::rename(TLS=arch1)%>%
  dplyr::rename(inflamm = arch2)%>%dplyr::rename(fibrotic=arch4)%>%
  dplyr::rename(cancer=arch3)


ggplot(data=MarkersCellsTMENS.reduc%>%filter(cell_type=="Keratin-positive tumor"& marker=="HLA_Class_1"),aes(x=inflamm*cancer,y=value))+
  geom_point(alpha=.1)+
  #geom_density_2d()+
  #scale_y_continuous(trans="log")+ #scale_x_continuous(trans="log")+
  stat_cor(method="spearman",cor.coef.name="rho",label.x=0.1)+
  stat_cor(method="pearson",cor.coef.name="R",label.y=4.0,label.x=0.1)+
  ggtitle("Ker+ tumor w/MHCI VS inflamm x cancer")

ggplot(data=MarkersCellsTMENS.reduc%>%filter(cell_type=="Tregs"& marker=="phospho.S6"),aes(x=inflamm*cancer,y=value))+
  geom_point(alpha=.1)+
  #geom_density_2d()+
  #scale_y_continuous(trans="log")+ #scale_x_continuous(trans="log")+
  stat_cor(method="spearman",cor.coef.name="rho",label.x=0.1)+
  stat_cor(method="pearson",cor.coef.name="R",label.y=4.0,label.x=0.1)+
  ggtitle("Tregs w/Phospho-S6 VS inflamm x cancer")

ggplot(data=MarkersCellsTMENS.reduc%>%filter(cell_type=="Neutrophils"& marker=="HLA.DR"),aes(x=inflamm,y=value))+
  geom_point(alpha=.1)+
  #geom_density_2d()+
  #scale_y_continuous(trans="log")+ #scale_x_continuous(trans="log")+
  stat_cor(method="spearman",cor.coef.name="rho",label.x=0.1)+
  stat_cor(method="pearson",cor.coef.name="R",label.y=4.0,label.x=0.1)+
  ggtitle("HLA-DR-expr Neutrophils VS inflamm")

ggplot(data=MarkersCellsTMENS.reduc%>%filter(cell_type=="Neutrophils"& marker=="PD.L1"),aes(x=inflamm*cancer,y=value))+
  geom_point(alpha=.1)+
  #geom_density_2d()+
  #scale_y_continuous(trans="log")+ #scale_x_continuous(trans="log")+
  stat_cor(method="spearman",cor.coef.name="rho",label.x=0.1)+
  stat_cor(method="pearson",cor.coef.name="R",label.y=4.0,label.x=0.1)+
  ggtitle("PD-L1-expr Neutrophils VS inflamm x cancer")

ggplot(data=MarkersCellsTMENS.reduc%>%filter(cell_type=="Neutrophils"& marker=="IDO"),aes(x=inflamm*cancer,y=value))+
  geom_point(alpha=.1)+
  #geom_density_2d()+
  #scale_y_continuous(trans="log")+ #scale_x_continuous(trans="log")+
  stat_cor(method="spearman",cor.coef.name="rho",label.x=0.1)+
  stat_cor(method="pearson",cor.coef.name="R",label.y=5.0,label.x=0.1)+
  ggtitle("IDO-expr Neutrophils VS inflamm x cancer")

ggplot(data=MarkersCellsTMENS.reduc%>%filter(cell_type=="NK"& marker=="CD138"),aes(x=fibrotic,y=value))+
  geom_point(alpha=.1)+
  #geom_density_2d()+
  #scale_y_continuous(trans="log")+ #scale_x_continuous(trans="log")+
  stat_cor(method="spearman",cor.coef.name="rho",label.x=0.1)+
  stat_cor(method="pearson",cor.coef.name="R",label.y=5.0,label.x=0.1)+
  ggtitle("CD138-expr NK VS fibrotic")

#### Does not follow a normal dist
## Many extreme outliers 
# spearman correlations instead
NeutroPDL1 <- MarkersCellsTMENS.reduc%>%filter(cell_type=="Neutrophils"& marker=="PD.L1")%>%pull(value)
hist(NeutroPDL1,breaks = 100,xlim=c(0,3))

boxplot(NeutroPDL1)
summary(NeutroPDL1)
shapiro.test(NeutroPDL1)
qqnorm(NeutroPDL1, pch = 1, frame = FALSE)
NeuPDL1.tmen  <- MarkersCellsTMENS.reduc%>%
  filter(cell_type=="Neutrophils"& marker=="PD.L1")%>%
  mutate(inflxcancer=inflamm*cancer)%>%
  mutate(intf = ifelse(inflxcancer<0.1,0,1))%>%
  mutate(pdl1= ifelse(value<1,0,1))
hist(pull(NeuPDL1.tmen,inflxcancer),breaks=50)
tab1 <-table(NeuPDL1.tmen%>%dplyr::select(c(intf,pdl1)))
fisher.test(tab1) #### Non-significant contigency table ==> the count of PDL1+ Neutrophils is independent from interface positivity
#qqline(NeutroPDL1, col = "steelblue", lwd = 2)

# ggplot(data=MarkersCellsTMENS1%>%filter(cell_type=="Neutrophils"& marker=="PD.L1"),aes(y=value))+
#   geom_boxplot()

```



```{r plot1, eval=FALSE,fig.width= 12,echo=FALSE}

# MarkersCellsTMENS.selected.cd4 <- MarkersCellsTMENS.selected%>%
#   filter(cell_type == "CD4-T")%>%
#   pivot_wider(id_cols = c("site_id","patient_id","arch1","arch2","arch3","arch4"),
#              names_from = "marker",
#              values_from = "value")

MarkersTMENs.kerPos <-MarkersCellsTMENS%>%
  filter(cell_type=="Keratin-positive tumor")%>%
  pivot_wider(id_cols=c("site_id","patient_id","arch1","arch2","arch3","arch4"),
             names_from = "marker",
             values_from = "value")

# TernaryPlot(atip = expression(arch1),
#              btip = expression(arch2),
#              ctip = expression(arch3))
# TernaryPoints(MarkersTMENs.kerPos[,c("arch1","arch2","arch3")],pch=19)
library(ggplot2)
library(ggtern)
MarkersTMENs.kerPos<-MarkersTMENs.kerPos%>%dplyr::rename(TLS=arch1)%>%
  dplyr::rename(inflamm = arch2)%>%dplyr::rename(fibrotic=arch4)%>%
  dplyr::rename(cancer=arch3)
options(ggplot2.continuous.colour="viridis")
#pdf("./TernaryPlot_KerPos_HLA1.pdf",width=5,height=4)
# ggtern(data=MarkersTMENs.kerPos, aes(x = cancer,y = inflamm, z = fibrotic,color = HLA_Class_1)) +
#   geom_point() +
#   labs(title="Local environment in Keratin-positive cancer cells") +
#   theme_custom(
#   base_size = 9,
#   base_family = "",
#   tern.plot.background = NULL,
#   tern.panel.background = NULL,
#   col.T = "red",
#   col.L = "magenta",
#   col.R = "steelblue",
#   col.grid.minor = "white"
# )
#dev.off()
library(ggpubr)
MarkersCellsTMENS1 <- MarkersCellsTMENS%>%dplyr::rename(TLS=arch1)%>%
  dplyr::rename(inflamm = arch2)%>%dplyr::rename(fibrotic=arch4)%>%
  dplyr::rename(cancer=arch3)

## TODO Make function of scatter plots of markers expression in cell types and niche weights 

# scatter_plot_ctM <- function(cellType, marker, ){
#   ggplot(data=MarkersCellsTMENS1%>%filter(cell_type=="CD8-T"& marker=="Beta.catenin"),aes(x=cancer*fibrotic,y=value))+
#   geom_point(alpha=.01)+
#   geom_density_2d()+
#   #scale_x_continuous(trans="log")+
#   stat_cor(method="spearman",cor.coef.name="rho",label.x=0.18)+
#   stat_cor(method="pearson",cor.coef.name="R",label.x=0.15)+
#   ggtitle("Beta catenin in CD8T cellls & cancer-fibr interface")
#   
# }



####POSITIVE CONTROLS
## HLA CLASS I IN KERATIN-POSITIVE TUMORS
ggplot(data=MarkersTMENs.kerPos,aes(x=inflamm*cancer,y=HLA_Class_1))+
  geom_point(alpha=.01)+
  geom_density_2d()+
  #scale_x_continuous(trans="log")+
  stat_cor(method="spearman",cor.coef.name="rho",label.x=0.2)+
  stat_cor(method="pearson",cor.coef.name="R",label.x=0.2,label.y=2)+
  ggtitle("HLA class I in Ker+ cells and inflamm-cancer interface")
## BETA CATENIN IN CD8 T CELLS
ggplot(data=MarkersCellsTMENS1%>%filter(cell_type=="CD8-T"& marker=="Beta.catenin"),aes(x=cancer*fibrotic,y=value))+
  geom_point(alpha=.01)+
  geom_density_2d()+
  #scale_x_continuous(trans="log")+
  stat_cor(method="spearman",cor.coef.name="rho",label.x=0.18)+
  stat_cor(method="pearson",cor.coef.name="R",label.x=0.15)+
  ggtitle("Beta catenin in CD8T cellls & cancer-fibr interface")

#### NEGATIVE CONTROLS
## dsDNA in KERATIN POSITIVE TUMORS VS CANCER
ggplot(data=MarkersTMENs.kerPos,aes(x=cancer,y=dsDNA))+
  geom_point(alpha=.01)+
  geom_density_2d()+
  #scale_y_continuous(trans="log")+ #scale_x_continuous(trans="log")+
  stat_cor(method="spearman",cor.coef.name="rho",label.x=0.70)+
  stat_cor(method="pearson",cor.coef.name="R",label.x=0.6,label.y=2.1)+
  ggtitle("dsDNA in Ker+ cells & cancer niche")

## dsDNA in KERATIN POSITIVE TUMORS VS INFLAMM Neutrophils;CD45RO in TLS
ggplot(data=MarkersCellsTMENS1%>%filter(cell_type=="Neutrophils"& marker=="CD45RO"),aes(x=TLS,y=value))+
  geom_point(alpha=.01)+
  geom_density_2d()+
  #scale_y_continuous(trans="log")+ #scale_x_continuous(trans="log")+
  stat_cor(method="spearman",cor.coef.name="rho",label.x=0.70)+
  ggtitle("CD45RO in Neutrophils & TLS")

### RANDOM CONTROLS (8 ct-markers VS TMENs)
TMENs <- c("TLS","inflamm","cancer","fibrotic")
set.seed(12)
rand.ct <- sample(CELLTYPES, 8)
rand.markers <- sample(MARKERS,8)
rand.tmens <- sample(TMENs,8,replace=TRUE)

MarkersCellsTMENS2 <- MarkersCellsTMENS1%>%pivot_longer(cols=c("cancer","TLS","inflamm","fibrotic"),names_to="tmen",values_to = "tmen_prop")
randCMs <- tibble(cell_type=rand.ct,marker=rand.markers,tmen=rand.tmens)
#merge(MarkersCellsTMENS2,randCMs, by=c("cell_type","marker","tmen"))

randsToPlot <- right_join(MarkersCellsTMENS2%>%dplyr::select(c(cell_type, marker, tmen, value, tmen_prop)),randCMs, by=c("cell_type","marker","tmen"))%>%mutate(ctMarker = paste0(cell_type,";",marker, " VS ",tmen))#%>%group_by(cell_type, marker,tmen)%>%summarise(count=n())
ggplot(data=randsToPlot,aes(x=tmen_prop,y=value))+
  facet_wrap(~ctMarker,nrow=2,ncol=4)+
  geom_point(alpha=.01)+
  geom_density_2d()+
  stat_cor(method="spearman",cor.coef.name="rho",label.x=0.30)

#MarkersCellsTMENS2%>%group_by(cell_type, marker, tmen)%>%filter(cell_type==randCMs$cell_type & marker ==randCMs$marker & tmen ==randCMs$tmen)

```


## Linear relationship between markers and TMENS ?


### Multivariate linear analysis of cell phenotypes-TMENs associations

```{r linReg1, eval=FALSE,echo=TRUE}
library(broom)
#niches <- c("a1","a2","a3","a4","a1a2","a1a3","a1a4","a2a3","a2a4","a3a4")

MarkersCellsTMENs.byNiche <- MarkersCellsTMENS2%>%
  filter(marker %in% FuncMarkers)%>%
  pivot_wider(names_from="marker",values_from="value")%>%pivot_longer(cols = c("arch1","arch2","arch3","arch4","a1a2","a1a3","a1a4","a2a3","a2a4","a3a4","a1a2a3","a1a2a4","a1a3a4","a2a3a4","a1a2a3a4"),names_to="niches",values_to="alpha")%>%
  filter(cell_type %in% c('CD8-T' , 'B', 'NK', 'Keratin-positive tumor', 'Tumor','CD4-T', 'Mesenchymal-like', 'Macrophages', 'Endothelial', 'Tregs', 'DC','Neutrophils'))%>%
  filter(niches %in%  c("arch1","arch2","arch3","arch4","a1a2","a1a3","a1a4","a2a3","a2a4","a3a4"))%>%
  mutate(id = paste(patient_id,site_id,cell_type,niches,sep="_"))%>%
  column_to_rownames(var="id")

## Get cells counts
nbCells <-  tmens_cells2%>%group_by(cell_type_site)%>%summarise(count=n())%>%dplyr::rename(cell_type=cell_type_site)#%>%pull(count)#MarkersCellsTMENS2%>%group_by(cell_type)%>%summarise(nb=n())

### Split table of cells niches into sub df by cell type and niche(core + interfaces)
NichesCellPhen <- group_split(left_join(MarkersCellsTMENs.byNiche,nbCells,by="cell_type")%>%group_by(niches,cell_type))
## GET NUMBER of cells
## #lapply(NichesCellPhen, function(x){nrow(x)})

## Fit linear regression, to make it 
### compute t stat * sqrt(nb of cells)
lmfit.stats <- lapply(NichesCellPhen ,function(x) {
  #nichesNames<-append(nichesNames,unique(pull(x,niches)))
  #cellT<-append(cellT,unique(pull(x,cell_type)))
  x<- x%>%mutate(id = paste(patient_id,site_id,cell_type,niches,sep="_"))%>%
  column_to_rownames(var="id")
  #print(x$count)
  #print(unique(pull(x,niches)))
  LinReg <-lm(alpha ~ Beta.catenin + CD138 + CD45RO + CD63 + FoxP3 + H3K27me3 + H3K9ac +  HLA.DR + HLA_Class_1 + IDO + Keratin17 + Keratin6 + Ki67 + Lag3 + p53 + PD.L1 + PD1 + phospho.S6, data = x) 
  tidy(LinReg)%>%mutate(term=paste(unique(pull(x,cell_type)),unique(pull(x,count)),term,sep=";"))%>%mutate(niche=rep(unique(x$niches)))#tidy(lm(alpha ~ Beta.catenin + CD138 + CD45RO 
  })

### Get predicted proportions of inflammatory niche of DCs 
#Predlm.DCa2 <- predict.lm(lm(alpha ~ Beta.catenin + CD138 + CD45RO + CD63 + FoxP3 + H3K27me3 + H3K9ac +  HLA.DR + HLA_Class_1 + IDO + Keratin17 + Keratin6 + Ki67 + Lag3 + p53 + PD.L1 + PD1 + phospho.S6, data =MarkersCellsTMENs.byNiche%>%
#                               filter(cell_type=="DC" & niches=="arch2")))#mutate(patient_id=str_split(id,"_")[[1]])

# boxplot(Predlm.DCa2)
# hist(Predlm.DCa2)
# 
#PredDCa2.df <- data.frame(id=names(Predlm.DCa2), value = Predlm.DCa2,row.names = NULL)%>%mutate(inflammatory_niche_pred = ifelse(value>=.5,1,0))%>%
#   separate(col=id,into= c("SampleID","label","cell_type","arch"),sep="_",convert=TRUE)
 
# write_csv(PredDCa2.df,"./outputs/predictedlm_alfa_a2_DC.csv")

## Remove intercept estimate from linear regression
## + correct t stat for cells counts
library(tidyverse)
dfStats <- lmfit.stats%>%reduce(full_join, by = c("term","niche","estimate","std.error","statistic","p.value"))
dfStats2 <- dfStats[!grepl("(Intercept)",dfStats$term),]#%>%separate(term, c("cell_type","count", "marker"),sep=";", remove=FALSE)%>%mutate(count = parse_number(count))#%>%
  #mutate(stat_hat = statistic/ sqrt(count))%>%dplyr::select(-c(cell_type, count, marker))


head(dfStats2)
dfStats%>%pull(term)%>%unique

View(dfStats2)#%>%filter(niche=="a2a3"))

```


```{r FDRt,fig.width=12,fig.height=6, eval=FALSE, echo=TRUE}

mat.tstat <- as.matrix(dfStats2%>%dplyr::select(-c(estimate,std.error,p.value))%>%pivot_wider(names_from = "niche",values_from="statistic")%>%column_to_rownames(var="term"))

mat.pval <- as.matrix(dfStats2%>%dplyr::select(-c(estimate,std.error,statistic))%>%pivot_wider(names_from = "niche",values_from="p.value")%>%column_to_rownames(var="term"))

## Check NA values are from the same rows from both p value and t stat matrices
rownames(mat.pval[rowSums(is.na(mat.pval)) > 0,]) ==rownames(mat.tstat[rowSums(is.na(mat.tstat))> 0,])

mat.tstat2 <- mat.tstat[rowSums(is.na(mat.tstat))==0,]#as_tibble(mat.tstat,rownames=NA)%>%drop_na()%>%as.matrix(rownames=TRUE)

mat.pval2 <-  mat.pval[rowSums(is.na(mat.pval))==0,]#as_tibble(mat.pval,rownames=NA)%>%drop_na()%>%as.matrix(rownames=TRUE)

## FDR correction for p-value
library(fdrtool)
fdrCorr <- fdrtool(mat.pval2%>% as.numeric(), #%>% as.matrix
            statistic = "pvalue")
  
CMtmens.qval<- 
    fdrCorr$lfdr %>% 
    matrix(nrow=nrow(mat.pval2), ncol=ncol(mat.pval2),
           dimnames = list(rownames(mat.pval2), colnames(mat.pval2)))

## Set to 0 non-significant estimates
mat.tstat2[CMtmens.qval>0.01]=0
## Check estimates that are non-significant for none of the niches
mat.tstat2[rowSums(mat.tstat2==0)==ncol(mat.tstat2),]

## Filter matrix of t stats ==> remove rows that are all non-signif, keep with at least 1 non signif association with a tmen
filtered.tstat <- mat.tstat2[rowSums(mat.tstat2==0)<ncol(mat.tstat2),]#CMtmens.qval<0.01 & 
## Select max t-stat per cell phenotype
maxNiches <- apply(filtered.tstat,1,max)
plot(sort(maxNiches))

as.vector(filtered.tstat)%>%summary
filtered.tstat2 <- filtered.tstat[names(sort(maxNiches,decreasing=TRUE)[1:110]),]#[names(maxNiches[maxNiches>3]),]#[names(sort(maxNiches)[1:75]),]
#plot(sort(apply(filtered.tstat2,2,max)))

filtered.tstat2[filtered.tstat2>5] = 5
filtered.tstat2[filtered.tstat2<(-5)] = -5
pheatmap(filtered.tstat2%>%t)


```



```{r heatmapLM, eval=FALSE,echo=TRUE}
### heatmap TEST
library(pheatmap)
pheatmap(filtered.tstat2%>%t)
#pheatmap(filtered.tstat[maxMatch.t==TRUE,]%>%t)

figWidth <- nrow(filtered.tstat2%>%t)*300/267#nrow(filtered.tstat[maxMatch.t==TRUE,]) * 30/267

pdf("./figs/t_statMatrix.pdf", height=6, width=ifelse(figWidth<6, 6, figWidth+2));
 pheatmap(filtered.tstat2%>%t);# (filtered.tstat[maxMatch.t==TRUE,]%>%t)
dev.off()

rownames(filtered.tstat2) <- str_replace_all(rownames(filtered.tstat2),"(?<=;)[:digit:]{2,6};","")

#library(RColorBrewer)
library(pheatmap)
cts <- unique(pull(as_tibble(filtered.tstat2,rownames=NA)%>%rownames_to_column(var="names")%>%separate(names,into=c("cell_type","marker"),sep=";"),cell_type))

markers2 <- unique(pull(as_tibble(filtered.tstat2,rownames=NA)%>%rownames_to_column(var="names")%>%separate(names,into=c("cell_type","marker"),sep=";"),marker))

CMt_ct <- as_tibble(filtered.tstat2,rownames=NA)%>%
     rownames_to_column(var="names")%>%
     separate(names,into=c("cell_type","marker"),sep=";")%>%
     pivot_longer(cols=c('arch1','arch2','arch3',"arch4","a1a2","a1a3","a1a4","a2a3","a2a4","a3a4"),names_to = "region",values_to="corr_val")%>%
    mutate(idx =match(cell_type, cts))%>%
    group_by(cell_type)%>%
    mutate(corr_val = corr_val+ (idx-1)*10)%>%
    pivot_wider(names_from="region", values_from="corr_val")%>%
    mutate(names = paste(cell_type,marker,sep=";"))%>%
    column_to_rownames(var="names")#%>%dplyr::select(-c(cell_type,idx))

dists <- dist(as.matrix(CMt_ct%>%dplyr::select(-c(cell_type,marker,idx))),method="euclidean")
hclustCells <- hclust(dists,method="ward.D") 
#plot(as.dendrogram(hclustCells))


## Annotations colors = length of cell types
cellTypes <- data.frame(cell_type =pull(CMt_ct ,cell_type))
Markers<- pull(CMt_ct ,marker)

colorCount = length(unique(pull(CMt_ct ,cell_type)))
getPalette = colorRampPalette(RColorBrewer::brewer.pal(9, "Set1"))
getPalette(colorCount)
# List with colors for each annotation.
CTcolors <- list(cell_type = getPalette(colorCount))
names(CTcolors$cell_type) <- unique(pull(CMt_ct ,cell_type))
rownames(cellTypes) <- rownames(CMt_ct)
#rownames(Markers) <-rownames(CM_TMENs_ct)
pdf("./figs/tMat_byCells.pdf",height=7, width=ifelse(figWidth<6, 6, figWidth+4))
pheatmap(t(filtered.tstat2),cluster_cols = hclustCells,cluster_rows = FALSE,annotation_col=cellTypes,annotation_colors= CTcolors,labels_col = Markers,border_color = "grey")#
dev.off()


```



```{r ROC, eval=FALSE,echo=TRUE}

#install.packages("pROC")
library(pROC)
# DC in inflammatory
# Neutrophils in inflammatory
# Tregs in cancer
# NK in fibrotic

# DCs in inflammatory niches: 1,3,6
## Sensitivity: cluster 1 

# Neutrophils in inflamm: clusters 6 and 9 
# NK in fibrotic: cluster 9 
# Tregs in cancer niche: cluster 9
CellsNiches <- c("arch2","arch2","arch3","arch4")
names(CellsNiches) <- c("DC","Neutrophils","Tregs","NK")

## Clusters IDs of each cell type that maps to cell phenotypes (of NIPMAP)
a <-c(1,2)
 
clustersCells <- c("DC"=c(1,3,6),"Neutrophils"=c(6,9),"Tregs"=c(9),"NK"=c(9))
clustersCells <- c("DC"=c(1,2,3,4,5,6,7,8,9,10),"Neutrophils"=c(1,2,3,4,5,6,7,8,9,10),"Tregs"=c(1,2,3,4,5,6,7,8,9,10),"NK"=c(1,2,3,4,5,6,7,8,9,10))

clustCells <- list("DC"=c(1,3,6),"Neutrophils"=c(6,9),"Tregs"=c(9),"NK"=c(9))
clustCells <- list("DC"=c(1,2,3,4,5,6,7,8,9,10),"Neutrophils"=c(1,2,3,4,5,6,7,8,9,10),"Tregs"=c(1,2,3,4,5,6,7,8,9,10),"NK"=c(1,2,3,4,5,6,7,8,9,10))
# SensSpe <- matrix(NA, nrow=length(names(CellsNiches)),ncol=3)
# colnames(SensSpe) <-c("cell_type","niche","cluster")
# SensSpe[,""]
SensSpe <- as_tibble(cbind(clustersCells),rownames=NA)%>%
  rownames_to_column(var="cell_type")%>%
  mutate(cell_type = str_replace_all(cell_type, "[:digit:]",""))%>%
  dplyr::rename(clust= clustersCells)%>%
  mutate(sensitivity=NA)%>%mutate(specificity=NA)

rocCells <- c("DC"="arch2","Neutrophils"="arch2","NK"="arch4","Tregs"="arch3")#("DC"="arch2")

ROCplots <- lapply(names(rocCells), function(x){
  ct <- x
  ar <- rocCells[x]
  print(ct)
  print(ar)
  S1 <- c()
  S2 <- c()
  ## GET hclusters of cell type
  hclusts.cells <- read.csv(paste0("./outputs/",ct,"_hclustIDs.csv"))%>%mutate(value=1)%>%pivot_wider(id_cols=c("cell_type","label","SampleID"),names_from="cluster",values_from="value",values_fill=0)
  
  ### GET observed nniche weight and set thresh to niche positivity to .5
  hclustsNiches.cells <- left_join(hclusts.cells%>%dplyr::rename(patient_id = SampleID)%>%dplyr::rename(site_id = label),tmens_cells2%>%dplyr::rename(cell_type = cell_type_site),by = c("patient_id","cell_type","site_id"))%>%
    mutate(AOI = get(ar))%>%
  drop_na(AOI)%>%
  mutate(archPos = ifelse(AOI>=.5,1,0))## We define cells that belong or not to archetype if their niche wieght is >.5
  ### Get predicted proportions of inflammatory niche of DCs 
  Predlm <- predict.lm(lm(alpha ~ Beta.catenin + CD138 + CD45RO + CD63 + FoxP3 + H3K27me3 + H3K9ac +  HLA.DR + HLA_Class_1 + IDO + Keratin17 + Keratin6 + Ki67 + Lag3 + p53 + PD.L1 + PD1 + phospho.S6, data =MarkersCellsTMENs.byNiche%>%
                              filter(cell_type==ct & niches==ar)))#mutate(patient_id=str_split(id,"_")[[1]])

  Pred.df <- data.frame(id=names(Predlm), value = Predlm,row.names = NULL)%>%mutate(niche_pred = ifelse(value>=.5,1,0))%>%
  separate(col=id,into= c("SampleID","label","cell_type","arch"),sep="_",convert=TRUE)
  
  NichesPredClust <- left_join(hclustsNiches.cells, Pred.df%>%dplyr::rename(patient_id=SampleID)%>%dplyr::rename(site_id=label),by=c("patient_id","cell_type","site_id"))
  ## Compute sensitivity, specificity of each cluster
  #clustCells <- pull(SensSpe, clustersCells)
  for(i in as.vector(clustCells[[ct]])){
    #print("ok")
    print(ct)
    print(i)
    clustCT <- hclustsNiches.cells%>%mutate(cell_type==ct)
    #print(clustCT[,c(i,"archPos")])
    counts <-table(clustCT[,c(i,"archPos")])
    print(counts)
    print(fisher.test(counts))
    sens <- counts['1','1']/sum(counts[,'1'])
    #print(sens)
    S1<- append(S1, sens)
    spe <- counts['0','0']/sum(counts[,'0'])
    S2 <- append(S2, spe)
    print(spe)
    #print(SensSpe[SensSpe$cell_type==ct & SensSpe$clust==i,])
    #SensSpe[SensSpe$cell_type==ct & SensSpe$clust==i,"sensitivity"]<-  counts['1','1']/sum(counts[,'1'])#sensitivity
    #SensSpe[SensSpe$cell_type==ct & SensSpe$clust==i,"specificity"]<- counts['0','0']/sum(counts[,'0'])#specificity
  }
  pdf(paste0("./figs/",ct,"_",ar,"ROC.pdf"));
  plot(NichesPredClust%>%roc(response=archPos,predictor=value),main=ct);
  points(S2,S1,pch=19, col="red");#(spe,sens,pch=19,col="red")
  #text(spe,sens,col="red",labels=i)
  legend(0.2,.2,legend=c("NIPMAP","hclust"),fill=c("black","red"));
  dev.off()
})

#print(ROClots)
# plot(ROCplots$DC)
# points(c(0.5),c(0.5))
####
# DCs in inflammatory niches: 1,3,6
## Sensitivity: cluster 1 

# Neutrophils in inflamm: clusters 6 and 9 
# NK in fibrotic: cluster 9 
# Tregs in cancer niche: cluster 9


####### TO CLEAN !#########
# hclusts.DC <- read.csv("./outputs/DC_hclustIDs.csv")%>%mutate(value=1)%>%pivot_wider(id_cols=c("cell_type","label","SampleID"),names_from="cluster",values_from="value",values_fill=0)
# 
# hclustsNiches.DC <- left_join(hclusts.DC%>%dplyr::rename(patient_id = SampleID)%>%dplyr::rename(site_id = label),tmens_cells2%>%dplyr::rename(cell_type = cell_type_site),by = c("patient_id","cell_type","site_id"))%>%
#   drop_na(arch1,arch2,arch3,arch4)%>%
#   mutate(a1 = ifelse(arch1>=.5,1,0))%>%
#   mutate(a2 = ifelse(arch2>=.5,1,0))%>%
#   mutate(a3 = ifelse(arch3>=.5,1,0))%>%
#   mutate(a4 = ifelse(arch4>=.5,1,0))
# NichesPredClust.DC <- left_join(hclustsNiches.DC, PredDCa2.df%>%dplyr::rename(patient_id=SampleID)%>%dplyr::rename(site_id=label),by=c("patient_id","cell_type","site_id"))
# 
# table(hclustsNiches.DC[,c("1","a2")])
### ROC curve 
#plot(NichesPredClust.DC%>%roc(response=a2,predictor=value))
#hclustsNiches.DC%>%mutate(a1 = ifelse(arch1>=.5,1,0))%>%mutate(a2=ifelse(arch2>=.5,1,0))%>%mutate(a3=ifelse(arch3>=.5,1,0))%>%mutate(a4=ifelse(arch4>=.5,1,0))



```


### Assessing phenotypes-TMENs with spearman correlations

```{r plots1,eval=TRUE,warning=FALSE,echo=TRUE}
#cMf <- correlations_tmens_CM(MarkersCellsTMENs=MarkersCellsTMENS,cellTypes=CELLTYPES, markers=FuncMarkers)
cMf<- correlations_tmens_CM(MarkersCellsTMENs=MarkersCellsTMENS2,cellTypes=CELLTYPES, markers=FuncMarkers)
write_csv(cMf%>%as_tibble(rownames=NA)%>%rownames_to_column(var="cell_marker"), "./CM_corr_tmens_thresh0.3.csv")
# if(file.exists()){
#   
# }else{
#   cMf <- correlations_tmens_CM(MarkersCellsTMENs=MarkersCellsTMENS,cellTypes=CELLTYPES, markers=FuncMarkers)
# }
# rm(cMf)
#saveRDS(cMf,"./corMatrixCM_fdr.rds")
#cMf <- readRDS("./corMatrixCM_fdr.rds")
figWidth <- nrow(cMf) * 30/267
#pheatmap(cMf%>%t)

#### Correct bleed-voer ==> remove cell Keratin6+ cell phenotypes inf cancer and inflamm x cancer
## Remove beta-catenin+ cell phenotypes: Beta-catenin is a non-specific marker involved ina wide range of pathways including cell communication and potentially immunosupression
cPh.toRemove<- cMf[which((grepl("Keratin6",rownames(cMf))& (cMf[,"a3"]>=.3| cMf[,"a2a3"]>=.3)) |(grepl("Beta.catenin",rownames(cMf))& (cMf[,"a3"]>=.3| cMf[,"a2a3"]>=.3))),]
cMf <-cMf[which(!(rownames(cMf) %in% rownames(cPh.toRemove))),]
pheatmap(cMf%>%t)
pdf("./figs/cMf.pdf", height=8, width=ifelse(figWidth<6, 6, figWidth+2)); pheatmap(cMf%>%t); dev.off()
######## VISUALIZATION ################
# figWidth <- nrow(cMf) * 30/267
# pdf("cMf_original.pdf", height=10, width=21); pheatmap(cMf %>% t,cluster_rows=FALSE,cluster_cols=FALSE); dev.off()

#pdf("./figs/cMf_reduced.pdf", height=8, width=ifelse(figWidth<6, 6, figWidth+2)); pheatmap(cMf %>% t); dev.off()

```


Reporting results in table (TMENs core & interface x cell phenotypes)

```{r tabCorrelations,fig.height=10, echo=TRUE}
library(grid)
library(gridExtra)
#install.packages("fontLiberation")
library(fontLiberation)

archetypesSitesKeren <- readRDS("/scratch/anissa.el/ImmuneStates/data_BB/archetypesSitesKeren.rds")
cellAbSites <- read_csv("/scratch/anissa.el/ImmuneStates/data_BB/abundance_matrix_gaussian.csv")

archs.CT <- get_CT_enriched_all_archs(archetypesSitesKeren,cellAbSites,thresh = 0.99)%>%group_by(niche)%>%filter(!(cell_type %in% c("DC / Mono", "CD3-T", "Mono / Neu", "Other immune")))%>%mutate(cell_type = paste(unique(cell_type),collapse="\n"))%>%distinct(niche,cell_type)
#names(archs.CT) <- set_tmens_names(names(archs.CT))


tabTMENs2 <- as_tibble(cMf,rownames=NA)%>%
  rownames_to_column(var="names")%>%
  separate(names,into=c("cell_type","marker"),sep=";")%>%
  mutate(marker=paste0(marker,"+"))%>%
  pivot_longer(cols=c('a1','a2','a3',"a4","a1a2","a1a3","a1a4","a2a3","a2a4","a3a4"),names_to = "niche",values_to="corr_val")#%>%
  #mutate(region =)%>%#(region = set_tmens_names(region))%>%
tabTMENs2$niche <- str_replace_all(pull(tabTMENs2,niche), c("a2a3"="inflammatoryxcancer",
                                                           "a1a3" = "TLSxcancer",
                                                           "a1a2"= "TLSxinflammatory",
                                                           "a1a4" = "TLSxfibrotic",
                                                           "a2a4" ="inflammatoryxfibrotic",
                                                           "a3a4" = "cancerxfibrotic"))
tabTMENs2$niche <- str_replace_all(pull(tabTMENs2,niche),c("a1" = "TLS","a2" = "inflammatory","a3" = "cancer","a4" = "fibrotic"))

tabTMENs2 <- tabTMENs2%>% filter(corr_val >=0.3)#%>% #### Select correlations that are >0.35
#  full_join(.,archs.CT,by="region")%>%group_by(region,cell_type.x,marker)%>%mutate(cell_type.y = paste(unique(cell_type.y),collapse="\n"))%>%ungroup()#left_join(., archs.CT,by=c("region","cell_type")) #### include cell_types that are representative of a given region

######### Compare correlations from core VS from interfaces
  # group by cell type, marker
  #find rows with a common detemrinant: a TMEN
    # split region into two (for 2- interfaces)
    # find intersect between two subregions ==> common TMEN
    # OR find the TMEN that has the highest occurence in a subregion (core and interfacees) across same CM VStmens associations
    # OR the same but for the second subregion
    # IF there is an association between CM and one region ==> common region is the latter
  # group again by cell type, marker, and by this common region
  # select the maximum
  #Get the correlations among core/interfaces for a given cell _type/marker that are the highest
  # Ex: rho (Beta-cat+ Tregs, cancer) < rho( Beta-cat+ Tregs, cancer x fibrotic) 
  # ==> select rho( Beta-cat+ Tregs, cancer x fibrotic)

tabCellPhen <- tabTMENs2%>%separate(col=niche, into = c("type1","type2"),sep="x")%>%group_by(cell_type,marker)%>%mutate(len= length(type1))%>%mutate(inter_region=ifelse(len==1,type1,
                                                                                                                                                                    ifelse(head(sort(table(type1),decreasing=TRUE),1)>1, names(head(sort(table(type1),decreasing=TRUE),1)),
                                                                                                                                                                          ifelse(head(sort(table(type2),decreasing=TRUE),1)>1,  names(head(sort(table(type2),decreasing=TRUE),1)),ifelse(length(intersect(type1,type2))==0,paste(type1,type2,sep="x"),intersect(type1,type2) )))))%>%group_by(cell_type, marker,inter_region)%>%filter(corr_val==max(corr_val))


tabCellPhen2 <- tabCellPhen %>%
  mutate(niche = paste(type1,type2,sep=" x "))%>%
  #full_join(.,archs.CT,by=("region"))%>%
  mutate(niche=str_replace_all(niche," x NA",""))%>%
  filter(!(cell_type %in% c("DC / Mono", "CD3-T", "Mono / Neu", "Other immune"))) %>%
  group_by(niche)%>%mutate(cells = paste(unique(cell_type),collapse='\n'))%>%
  # mutate(region=str_replace_all(region," x NA",""))%>%
  # group_by(region)%>%
  # mutate(cellPh2 = paste(unique(cell_type),collapse="\n"))%>%
  # ungroup()%>%
  # mutate(cellPh = ifelse(region %in% pull(archs.CT,region),paste(archs.CT[archs.CT$region==region,"cell_type"],collapse="\n"),"")) %>%
  group_by(niche,cell_type)%>% 
  mutate(cell_phenotype= paste0(paste(marker, collapse = " "),cell_type)) %>%
  ungroup()%>%

  group_by(niche)%>%
  mutate(cell_phenotype=paste(unique(cell_phenotype),collapse="\n")) %>%
  distinct(niche, .keep_all = TRUE)%>%
  arrange(niche)%>%dplyr::select(niche, cells,cell_phenotype)



tabCellPhen3 <- tabCellPhen2%>%
  #mutate(region=str_replace_all(region," x NA",""))%>%
  mutate(cellPh =ifelse(niche %in% pull(archs.CT,niche),paste(archs.CT[archs.CT$niche==niche ,"cell_type"],collapse="\n"),""))%>%
  rowwise()%>%
  mutate(ct = ifelse(grepl("\n",cellPh,fixed=TRUE)==FALSE,paste(setdiff(as.vector(cellPh),str_split(cells,"\n")[[1]]),collapse="\n"),ifelse(grepl("\n",cells,fixed=TRUE)==FALSE,paste(setdiff(str_split(cellPh,"\n")[[1]], as.vector(cells)),collapse="\n"),paste(setdiff(str_split(cellPh,"\n")[[1]],str_split(cells,"\n")[[1]]),collapse="\n"))))%>%
  mutate(cell_phenotype = paste(cell_phenotype,ct,sep="\n"),.keep="unused")%>%
  dplyr::select(-c(cells, cellPh))%>%#mutate(sign  = "+")
  #distinct(region, .keep_all = TRUE)%>%
  arrange(niche)



#### TEST
#tabCellPhen3%>%rowwise()%>%mutate(ct = ifelse(grepl("\n",cellPh,fixed=TRUE)==FALSE,paste(setdiff(as.vector(cellPh),str_split(cells,"\n")[[1]]),collapse="\n"),ifelse(grepl("\n",cells,fixed=TRUE)==FALSE,paste(setdiff(str_split(cellPh,"\n")[[1]], as.vector(cells)),collapse="\n"),paste(setdiff(str_split(cellPh,"\n")[[1]],str_split(cells,"\n")[[1]]),collapse="\n"))))

### Display and save table in pdf
 # th1 <- ttheme_minimal(colhead=list(bg_params=list(col="black",fill = "white")),
 #                       core=list(bg_params = list(fill = 'white', col="black")))
   th1 <- ttheme_default()#colhead=list(bg_params=list(fontfamily="liberation")),
  #                      core=list(bg_params = list(fontfamily="liberation")))
 
 g1 <- tableGrob(tabCellPhen3,rows=NULL,theme = th1)#(tabCellPhen2%>%mutate(region=str_replace_all(region," x NA","")),rows=NULL,theme = th1)
                 #gpar.corefill = gpar(fill = "white", col = "grey95"))
 grid.newpage()
 grid.draw(g1)
 ggsave("./figs/tab_tmens.pdf",g1,width=7,height=10)
# 
 #rm(g1)

```

#### Heatmaps organized by cell types and markers


```{r corrCells,eval=TRUE }
library("RColorBrewer")
cts <- unique(pull(as_tibble(cMf,rownames=NA)%>%rownames_to_column(var="names")%>%separate(names,into=c("cell_type","marker"),sep=";"),cell_type))
markersCorr <- unique(pull(as_tibble(cMf,rownames=NA)%>%rownames_to_column(var="names")%>%separate(names,into=c("cell_type","marker"),sep=";"),marker))

######### HEATMAP ORGANIZED BY CELL TYPES ###########
CM_TMENs_ct <- as_tibble(cMf,rownames=NA)%>%
     rownames_to_column(var="names")%>%
     separate(names,into=c("cell_type","marker"),sep=";")%>%#mutate(marker=paste0(marker,"+"))%>%
     pivot_longer(cols=c('a1','a2','a3',"a4","a1a2","a1a3","a1a4","a2a3","a2a4","a3a4"),names_to = "region",values_to="corr_val")%>%
   mutate(idx =match(cell_type, cts))%>%
     group_by(cell_type)%>%mutate(corr_val = corr_val+ (idx-1)*10)%>%pivot_wider(names_from="region", values_from="corr_val")%>%mutate(names = paste(cell_type,marker,sep=";"))%>%column_to_rownames(var="names")#%>%dplyr::select(-c(cell_type,idx))

dists <- dist(as.matrix(CM_TMENs_ct%>%dplyr::select(-c(cell_type,marker,idx))),method="euclidean")
hclustCells <- hclust(dists,method="ward") 
#plot(as.dendrogram(hclustCells))
cellTypes <- data.frame(cell_type =pull(CM_TMENs_ct ,cell_type))
Markers<- pull(CM_TMENs_ct ,marker)
## Annotations colors = length of cell types
colorCount = length(CELLTYPES)
getPalette = colorRampPalette(brewer.pal(9, "Set1"))
getPalette(colorCount)
# List with colors for each annotation.
CTcolors <- list(cell_type = getPalette(colorCount))
names(CTcolors$cell_type) <- CELLTYPES
rownames(cellTypes) <- rownames(CM_TMENs_ct)
#rownames(Markers) <-rownames(CM_TMENs_ct)
pdf("./figs/cM_byCells3.pdf",height=8, width=ifelse(figWidth<6, 6, figWidth+2))
pheatmap(t(cMf),cluster_cols = hclustCells,cluster_rows = FALSE,annotation_col=cellTypes,annotation_colors= CTcolors,labels_col = Markers)#
dev.off()

########### HEATMAP ORGANIZED BY MARKERS ###########
CM_TMENs_ph <- as_tibble(cMf,rownames=NA)%>%
     rownames_to_column(var="names")%>%
     separate(names,into=c("cell_type","marker"),sep=";")%>%#mutate(marker=paste0(marker,"+"))%>%
     pivot_longer(cols=c('a1','a2','a3',"a4","a1a2","a1a3","a1a4","a2a3","a2a4","a3a4"),names_to = "region",values_to="corr_val")%>%
   mutate(idx =match(marker, markersCorr))%>%arrange(marker)%>%
     group_by(marker)%>%mutate(corr_val = corr_val+ (idx-1)*10)%>%pivot_wider(names_from="region", values_from="corr_val")%>%mutate(names = paste(marker,cell_type,sep=";"))%>%column_to_rownames(var="names")#%>%dplyr::select(-c(marker,idx))

Markers2 <- data.frame(marker= pull(CM_TMENs_ph,marker))
rownames(Markers2) <- rownames(CM_TMENs_ph)
cellTypes2 <- pull(CM_TMENs_ph,cell_type)

dists2 <- dist(as.matrix(CM_TMENs_ph%>%dplyr::select(-c(marker,cell_type,idx))),method="euclidean")
hclustPhen <- hclust(dists2,method="ward") 
#plot(as.dendrogram(hclustPhen))

cMf.copy <- cMf
rownames(cMf.copy)<- unname(unlist(sapply(rownames(cMf.copy),function(x){paste0(strsplit(x,";")[[1]][2],";",strsplit(x,";")[[1]][1])})))#sub('(\\w|\\.|\\_|\\ / |+);(\\w|.|_| / |+)', '\\2;\\1', rownames(cMf))#sub('([^;]);([^;])', '\\2;\\1^', rownames(cMf))
# 
cMf_ordered <- cMf.copy%>%as_tibble(rownames=NA)%>%rownames_to_column(var="names")%>%separate(col="names",into=c("marker","cell_type"),sep=";")%>%group_by(marker)%>%arrange(marker)%>%mutate(names=paste0(marker,";",cell_type))%>%column_to_rownames(var="names")%>%dplyr::select(-c(cell_type,marker))

pdf("./figs/cM_byMarkers2.pdf",height=8, width=ifelse(figWidth<6, 6, figWidth+2))
pheatmap(as.matrix(cMf_ordered%>%t),cluster_cols = hclustPhen,cluster_rows = FALSE,annotation_col = Markers2,labels_col = cellTypes2)
dev.off()

rm(cMf.copy)
rm(CM_TMENs_ph)
rm(CM_TMENs_ct)
#pheatmap(t(as.matrix(CM_TMENs_ct)),cluster_cols = TRUE,cluster_rows = FALSE)

```

#### Niche-phentoype mapping per cell type 

```{r cellsTMENs,eval=TRUE}
library(RColorBrewer)
library(pheatmap)

## Get cell types that are associated with a tmen/interface
cts <- unique(pull(as_tibble(cMf,rownames=NA)%>%rownames_to_column(var="names")%>%separate(names,into=c("cell_type","marker"),sep=";"),cell_type))
markersCorr <- unique(pull(as_tibble(cMf,rownames=NA)%>%rownames_to_column(var="names")%>%separate(names,into=c("cell_type","marker"),sep=";"),marker))


### Classify correlations by cell type
# CM_TMENs_ct <- as_tibble(cMf,rownames=NA)%>%
#      rownames_to_column(var="names")%>%
#      separate(names,into=c("cell_type","marker"),sep=";")%>%
#      mutate(marker=paste0(marker,"+"))%>%pivot_longer(cols=c('a1','a2','a3',"a4","a1a2","a1a3","a1a4","a2a3","a2a4","a3a4"),names_to = "region",values_to="corr_val")%>%
#    mutate(idx =match(cell_type, cts))%>%
#      group_by(cell_type)%>%mutate(corr_val = corr_val+ (idx-1)*10)%>%pivot_wider(names_from="region", values_from="corr_val")%>%mutate(names = paste(cell_type,marker,sep=";"),.keep="unused")%>%column_to_rownames(var="names")%>%dplyr::select(-c(cell_type,idx))
# 
# pdf("./figs/tweakedCM_corr.pdf",height=8, width=ifelse(figWidth<6, 6, figWidth+2));pheatmap(t(as.matrix(CM_TMENs_ct)),cluster_cols = TRUE,cluster_rows = FALSE);dev.off()


#### NEW VERSION 
# We proceed cell type wise and do hierarchical clustering of the markers to group the phenotypes together
# 1 plot for 1 cell type
# same color bar
# export heatmaps into pdf with same cell size of the matrix
# group them manually in Inkscape 
corrCM <- readRDS("./corMatrix_raw.rds")
corrCM <-corrCM[rowSums(is.na(corrCM))==0,]
breaksCols <- seq(min(corrCM),max(corrCM),by=.1) # cMf
ct_df <-group_split(as_tibble(corrCM,rownames=NA)%>%rownames_to_column(var="names")%>%separate(names,into=c("cell_type","marker"),sep=";")%>%group_by(cell_type))

list_heatmapsCT <- lapply(ct_df,FUN = function(x){
  ct <- str_replace(unique(x$cell_type),"/","_" )#strsplit(rownames(x)["cell_type"],';')[[1]][1]
  print(ct)
  #p <- pheatmap(as.matrix(x%>%mutate(names= paste(cell_type,marker),.keep="unused")%>%column_to_rownames(var="names")),cluster_rows = TRUE,cluster_cols = FALSE)
  #print(ct)
  # pheatmap(as.matrix(x%>%mutate(names= paste(cell_type,marker),.keep="unused")%>%column_to_rownames(var="names")%>%t()),
  #                                                    color = colorRampPalette(rev(brewer.pal(n = 7,name = "RdYlBu")))( length(breaksCols)), cluster_rows = TRUE,
  #                                                    cluster_cols = FALSE,
  #                                                    cell_width=1,cell_height = 2)
  #pdf(paste0("./figs/",ct,".pdf"));
  colnames(x) <- str_replace_all(colnames(x), c("a2a3"="inflammxcancer",
                                                           "a1a3" = "TLSxcancer",
                                                           "a1a2"= "TLSxinflamm",
                                                           "a1a4" = "TLSxfibrotic",
                                                           "a2a4" ="inflammxfibrotic",
                                                           "a3a4" = "cancerxfibrotic"))
  colnames(x) <- str_replace_all(colnames(x),c("a1" = "TLS","a2" = "inflamm","a3" = "cancer","a4" = "fibrotic"))
  pdf(paste0("./figs/",ct,".pdf"));
  pheatmap(as.matrix(x%>%arrange(marker)%>%column_to_rownames(var="marker")%>%dplyr::select(-(cell_type))),#x%>%mutate(names= paste(cell_type,marker),.keep="unused")%>%column_to_rownames(var="names")),#%>%t()),
                                                     color = colorRampPalette(rev(brewer.pal(n = 7,name = "RdYlBu")))( length(breaksCols)), cluster_cols = TRUE,
                                                     cluster_rows = FALSE,main=ct,
                                                     cell_width=1,cell_height = 2);
  dev.off()
  
})


```

#### PCA on correlation matrix of cell markers VS TMENs

Can we find cross-cells phenotypes that are associated to niches ? Are they associated to core niches or do they arise at the interface ?
If so, is it a continuum or do we have clusters ?

```{r pcaCor, fig.height = 15,fig.width=15,echo=TRUE}
###PCA on correlation matrix
library(pheatmap)
library(RColorBrewer)
library(ggplot2)
CM_TMENs.pca <- dudi.pca(cMf[,c('a1','a2','a3',"a4","a1a2","a1a3","a1a4","a2a3","a2a4","a3a4")],center=FALSE, scale=TRUE,scannf=FALSE,nf=3)
fviz_eig(CM_TMENs.pca)
fviz_pca_var(CM_TMENs.pca,col.var = "red",repel=TRUE)
fviz_pca_var(CM_TMENs.pca,axes=c(1,3),col.var = "red",repel=TRUE)
fviz_pca_ind(CM_TMENs.pca)
CM <- cMf%>%as_tibble(rownames=NA)%>%rownames_to_column(var="names")%>%separate(col=names, into=c("cell_type","marker"),sep=";")%>%dplyr::select(c(cell_type,marker))

# CM_TMENs.pca$co[,1:3] <- sweep(CM_TMENs.pca$co[,1:3], 2, CM_TMENs.pca$eig[1:3]^0.8, FUN='/')
# CM_TMENs.pca$li[,1:3] <- sweep(CM_TMENs.pca$li[,1:3], 2, CM_TMENs.pca$eig[1:3], FUN='/')

colorCount = length(unique(CM$marker))
getPalette = colorRampPalette(brewer.pal(9, "Set1"))


# plot1 <- ggplot(data = cbind(CM_TMENs.pca$li[,1:2],CM), aes(x = Axis1, y = Axis2,color=marker,shape= cell_type,size=3)) + 
#       geom_point()+scale_color_manual(values=getPalette(colorCount))+
#   scale_shape_manual(values=c(0,1,2,3,4,5,6,7,8,9,10,12,13,16,17,18))+#c(0:length(unique(CM$cell_type))-1)
#           xlab("PC 1") + ylab("PC 2")
# 
# plot1

# plot2 <- ggplot(data = cbind(CM_TMENs.pca$li[,1:3],CM), aes(x = Axis1, y = Axis3,color=marker,shape= cell_type,size=3)) + 
#       geom_point()+scale_color_manual(values=getPalette(colorCount))+
#   scale_shape_manual(values=c(0,1,2,3,4,5,6,7,8,9,10,12,13,16,17,18))+#c(0:length(unique(CM$cell_type))-1)
#           xlab("PC 1") + ylab("PC 3")
# 
# 
# plot2
# 
# 
fig1 <- plot_ly(x = CM_TMENs.pca$li[,1],
           y = CM_TMENs.pca$li[,2],
           z = CM_TMENs.pca$li[,3],
           type="scatter3d",
           #color = ~markerCells,
           alpha = 0.5,
           mode="markers",
           name= "cells",
           marker = list(size= 5),
           showlegend=TRUE)%>%
    layout(scene = list(xaxis = list(title = "PC1"),
                                       yaxis = list(title = "PC2"),
                                       zaxis = list(title = "PC3") ))
#fig1

```

(( However,  niche negatively associates with PC3, showing that this interface mostly anti-correlates with the existing phenotypes in the TME. PC3 is not very informative.))


PCA on correlations between cells protein expression and TMENs justify to reduce the dimension from 15 to 2 PCs  as they explain 77 % of the variance. Fibrotic niche and TLS covary together along the first Principal Component. While the cancer niche correlates with the PC2, the inflammatory niche and its interfaces including fibrotic and TLS niches anti-correlates with both principal components. interfaces between cancer niche and inflammatory niches negatively correlate with the first principal component. This shows that some local environment vary together and might unravel hierarchical specific phenotypes.


The third Principal Component explains 12 % of the total variance. TLS-cancer as well as TLS niche positively associates with the PC3.

```{r plotsa2a3,echo=TRUE}
corr_cm <-as_tibble(cMf,rownames=NA)%>%rownames_to_column(var="names")%>%separate(col=names, into=c("cell_type","marker"),sep=";")%>%filter(!(cell_type %in% c("DC / Mono", "Mono / Neu","Other immune")))%>%mutate(marker=ifelse(marker%in%c("phospho.S6","Beta.catenin","HLA_Class_1"),marker,"other"))#%>%group_by(marker)%>%mutate(randA2 = ifelse(marker=="other",rnorm(),))
library(RColorBrewer)
#library(tune)
colorCount = length(unique(corr_cm$marker))
#getPalette = colorRampPalette(brewer.pal(9, "Set1"))#Dark2

ggplot(corr_cm, aes(x=a3,y=a2,color=marker,shape=cell_type))+
  geom_hline(yintercept=0, color="black",linetype= "dashed") + geom_vline(xintercept=0,color="black",linetype="dashed")+
  geom_point(size = 4)+#scale_color_brewer(palette="Set1")+#scale_color_manual(values=getPalette(colorCount))+
  scale_shape_manual(values=c(0,1,2,3,4,5,6,7,8,9,10,12,13,16,17,18))+# scale_shape_manual(values = c(0,3,18,7))++# 7,3,5
  scale_color_manual(values=c("#DB121F","#DBA012","#999999","#DB129F"))+
  ylab("Association to inflammatory niche")+xlab("Association to cancer niche")+
  
  xlim(-0.5,max(cbind(corr_cm$a2,corr_cm$a3))) + ylim(-0.5,max(cbind(corr_cm$a2,corr_cm$a3)))
ggsave("./figs/corrCancerInfl.pdf",width=6,height=4)
  
  
```

#### Sum of Squares of correlations per TMENs (core and interfaces)

To understand with cores/interfaces of TMENs associate (positively or negatively) best to environment, we compute the sum of squares of the spearman correlations for each environment:

```{r SScors}
#install.packages("ggrepel")
library(ggrepel)
coreCorr <- cMf[,c('a1','a2','a3',"a4")]
interCorr <- cMf[,c("a1a2","a1a3","a1a4","a2a3","a2a4","a3a4")]
SS <- apply(cMf[,c('a1','a2','a3',"a4","a1a2","a1a3","a1a4","a2a3","a2a4","a3a4")],2, function(x) sum(x)^2)#var(x) #sum(x-mean(x))^2
sort(SS)
names(SS) <- str_replace_all(names(SS), c("a2a3"="inflammatory x cancer",
                                                           "a1a3" = "TLS x cancer",
                                                           "a1a2"= "TLS x inflammatory",
                                                           "a1a4" = "TLS x fibrotic",
                                                           "a2a4" ="inflammatory x fibrotic",
                                                           "a3a4" = "cancer x fibrotic"))
names(SS) <- str_replace_all(names(SS),c("a1" = "TLS","a2" = "inflammatory","a3" = "cancer","a4" = "fibrotic"))

x <- rep(0,length(SS))
tmens_SS <- as_tibble(cbind(SS,x),rownames=NA)%>%rownames_to_column(var="tmen")%>%mutate(type = ifelse(tmen %in% c("TLS","inflammatory","cancer","fibrotic"),"core","interface"))
p <- ggplot(tmens_SS , aes(x, SS,color=type,label=tmen)) + geom_point()+ylab("Sum of squares of association scores of all phenotypes")+geom_text_repel()
p + theme(axis.line.x=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.title.x=element_blank(),
          panel.grid.minor.x=element_blank(),
          panel.grid.major.x=element_blank())
ggsave("./figs/SS_tmens.pdf",height=4,width=3)

```

 * The interface between cancer and inflammatory niches is highly correlated with specific phenotypes. It associates the most phenotypes with environment. 
 
 * Many cell phenotypes highly associate with the fibrotic niche (mostly anti-correlations): most cells anti-correlate with this niche because it has a low cell density. We also lack stromal markers and ECM markers as well as some cytokines. 
 
 * The cancer niche has an average SS, it correlates with cell phenotypes observed such as beta catenin, phospho S6 and keratin. 
 
 * The inflammatory niche is the third environment whose SS is high meaning that it highly correlates with cell phenotypes that are likely to be pro-inflammatory
 
 * Cell phenotypes poorly correlate with a TLS-cancer niches interface. This suggests that either there is no phenotype that is specific to this environment or simply that we find almost no cells at this interface or that the panel of markers doesn't cover proteins that might be in this region.
 
 * In general, interfaces with TLS have a poor SS value. It reveals that there are few phenotypes that highly associate with those specific immune contextures, or that phenotypes poorly associate with them.
 
 In conclusion, cancer-inflammation interface is the interface that associates best phenotypes with space. In other words, this is the context for generation of environment-dependent cell phenotypes such as antigen presentation or immunosuppression. Previous work reveal that the latter enhances tumor growth and immune escape


```{r cors2, eval=FALSE, echo=TRUE}
#############################-------------------TO CLEAN-------------------#############################
## look for interface markers

coreIdx <- which(colnames(corCMtmens.qval) %in% c("a1", "a2", "a3", "a4"))
intfIdx <- setdiff(1:ncol(corCMtmens.qval), coreIdx)
# corIntfCoretmens <-cMf%>%as_tibble(rownames=NA)%>%
#   rownames_to_column(var="names")%>%
#   pivot_longer(cols = c("a1", "a2", "a3", "a4"),names_to = "coreTMEN",values_to = "coreVal")%>%
#   pivot_longer(cols = c("a1a2","a1a3","a1a4","a2a3","a2a4", 
#                   "a3a4","a1a2a3","a1a2a4","a1a3a4","a2a3a4","a1a2a3a4"),names_to = "intfTMEN",values_to = "intfVal")%>%
#   group_by(names,coreTMEN,intfTMEN)%>%mutate(interface = ifelse((abs(coreVal)<abs(intfVal))&(grepl(coreTMEN,intfTMEN,fixed=TRUE)),TRUE,FALSE))%>%filter(interface==TRUE)%>%filter(grepl("Unidentified",names,fixed=TRUE)==FALSE)
# 
# corIntfCoretmens2 <- corIntfCoretmens%>%ungroup()%>%group_by(names,intfTMEN)%>%distinct(intfTMEN,.keep_all=TRUE)%>%dplyr::select(c(names,intfTMEN,intfVal))%>%pivot_wider(id_cols = c("names","intfTMEN"),names_from="intfTMEN",values_from="intfVal")%>%column_to_rownames((var="names"))
# pdf("./corIntfTMENs.pdf",height=8,width=15)
# pheatmap(as.matrix(corIntfCoretmens2),cluster_rows=FALSE, cluster_cols=FALSE)
# dev.off()
# 
# corsInterf <- cMf[names(which(apply(cMf[,coreIdx]<cMf[,intfIdx],1,sum)>0)),]

# coreIdx <- which(colnames(corCMtmens.qval) %in% c("a1", "a2", "a3", "a4"))
# intfIdx <- setdiff(1:ncol(corCMtmens.qval), coreIdx)
# intfOnlyIdx <- (apply(corCMtmens.qval[,coreIdx] < qThreshold, 1, sum) == 0 & apply(corCMtmens.qval[,intfIdx] < qThreshold*5, 1, sum) > 0) 
#intfOnlyIdx = 
#which(intfOnlyIdx)

#intfOnlyIdx = (apply(corMatrix[,coreIdx] < qThreshold, 1, sum) == 0 & apply(corCMtmens.qval[,intfIdx] < qThreshold, 1, sum) > 0) 
#### FIlter only the duo cell type,marker that has significantly non-null correlations with interface of TMENs 
# cMf <- corMatrix[names(which(intfOnlyIdx)),]
# figWidth<-nrow(cMf) * 30/267
# pdf("cMf_intf.pdf", height=6, width=ifelse(figWidth<6, 6, figWidth)); pheatmap(cMf %>% t); dev.off()
# pheatmap(cMf)

#matrix(1:12, 3, 4) %>% as.numeric() %>% matrix(3, 4)

pheatmap(t(as.matrix(corCMtmens%>%column_to_rownames(var="names"))),display_numbers= t(round(as.matrix(corCMtmens.pval%>%column_to_rownames(var="names")),3)))

## Significant correlations with  1 TMEN
corCM_1TMEN.pval <- corCMtmens.pval%>%dplyr::select(names,a1,a2,a3,a4)%>%filter(a1<=0.05 |a2<=0.05|a3<=0.05|a4<=0.05)
corCM_1TMEN <- merge(corCMtmens%>%dplyr::select(names,a1,a2,a3,a4),corCM_1TMEN.pval,by=c("names"))#%>%filter(a1<=0.05 |a2<=0.05|a3<=0.05|a4<=0.05)

pheatmap(t(as.matrix(corCM_1TMEN%>%column_to_rownames(var="names")%>%dplyr::select(c(a1.x,a2.x,a3.x,a4.x)))),
         display_numbers =t(round(as.matrix(corCM_1TMEN.pval%>%column_to_rownames(var="names")),3)))

### Significant correlations with interfaces of TMENs
corCM_inter_2TMENs.pval <- corCMtmens.pval%>%
  dplyr::select(names,a1a2,a1a3,a1a4,a2a3,a2a4,a3a4)%>%
  filter(a1a2<=0.05 | a1a3<=0.05 | a1a4<=0.05 | a2a3<=0.05 | a2a4<=0.05 | a3a4<=0.05)

corCM_inter_2TMENs <- merge(corCMtmens%>%dplyr::select(names,a1a2,a1a3,a1a4,a2a3,a2a4,a3a4),
                            corCM_inter_2TMENs.pval,
                            by = c("names"))
pheatmap(t(as.matrix(corCM_inter_2TMENs%>%column_to_rownames(var = "names")%>%dplyr::select(c(a1a2.x,a1a3.x,a1a4.x,a2a3.x,a2a4.x,a3a4.x)))),
         display_numbers = t(round(as.matrix(corCM_inter_2TMENs.pval%>%column_to_rownames(var = "names")),3)))


corCM_inter3TMENs.pval  <- corCMtmens.pval%>%dplyr::select(names,a1a2a3,a1a2a4,a1a3a4,a2a3a4)%>%filter(a1a2a3<=0.05 |a1a2a4<=0.05 | a1a3a4<=0.05 | a2a3a4<=0.05)
corCM_inter3TMENs <- merge(corCMtmens%>%dplyr::select(names,a1a2a3,a1a2a4,a1a3a4,a2a3a4),corCM_inter3TMENs.pval,by="names")

# heatmap(as.matrix(corCM_1TMEN), Rowv=NA,Colv = NA,scale="none",
#         labRow = corMatrix%>%as_tibble(rownames=NA)%>%rownames_to_column(var="names")%>%pull(names))
#res <-as_tibble(corMatrix,rownames=NA)%>%filter(a1a2>=0.05)

## Significant correlations with interfaces of 3 TMENs
corCM_TMENS_signif <- corMatrix%>%as_tibble(rownames=NA)%>%
  rownames_to_column(var="names")%>%
  separate(names,into=c("cell_type","marker"),sep=";")%>%
  drop_na()%>%filter(a1<=0.05 |a2<=0.05|a3<=0.05|a4<=0.05|a1a2<=0.05 |a1a3<=0.05|a1a4<=0.05|a2a3<=0.05|a2a4<=0.05|a3a4<=0.05| a1a2a3<=0.05 |a1a2a4<=0.05|a1a3a4<=0.05|a2a3a4<=0.05)

cts <- unique(corCM_TMENS_signif%>%pull(cell_type))
combCT <- corMatrix%>%as_tibble(rownames=NA)%>%rownames_to_column(var="names")%>%pull(names)
# h1 <- list()
# 
# redgreen <- c("green","red" ) 
# pal <- colorRampPalette(redgreen)(100)

# library(lattice)
# 
# h1 <- lapply(X=cts,function(c){
#   markersCT <- combCT[str_detect(combCT,paste0(c,";"))]
#   matrixToPlot <- as.matrix(corCM_TMENS_signif)
#   rownames(matrixToPlot) <-combCT 
#   matrixToPlot2 <- as_tibble(matrixToPlot,rownames=NA)%>%filter(cell_type==c)%>%dplyr::select(c(a1,a2,a3,a4,a1a2,a1a3,a1a4,a2a3,a2a4,a3a4,a1a2a3,a1a2a4,a1a3a4,a2a3a4))
#   fig <-levelplot(matrixToPlot,xlab = paste0("markers for cell type  ",c),ylab = c("TLS","infl.","cancer","fibr","TLS-infl","TLS-cancer","TLS-fibr","infl-cancer","infl-fibr","cancer-fibr","TLS-infl-canc","TLS-infl-fibr","TLS-cancer-fibr","infl-cancer-fibr"))#heatmap(matrixToPlot,Rowv = NA,Colv=NA, scale="none", 
#                 #labRow  = combCT,col=pal)
#   print(fig)
# })
# for (c in range(cts)){
# fig <- heatmap(as.matrix(corCM_TMENS_signif%>%dplyr::select(c(a1,a2,a3,a4,a1a2,a1a3,a1a4,a2a3,a2a4,a3a4,a1a2a3,a1a2a4,a1a3a4,a2a3a4)),Rowv = NA,Colv=NA, scale="none", 
#    labROw  = combCT))
# append(h1,fig)
# }


```



```{r plot2, eval=FALSE,echo=FALSE}
############## TO CLEAN #############
# library(geometry)
# 
# plot_3D_ternary_cell_markers <- function (cellType, marker){
#   MarkersCellsTMENS.ct <- MarkersCellsTMENS%>%
#   filter(cell_type == cellType)%>%
#   pivot_wider(id_cols = c("site_id","patient_id","arch1","arch2","arch3","arch4"),
#              names_from = "marker",
#              values_from = "value")
#   X <- rbind(c(1, 0, 0),
#              c(0, 1, 0),
#              c(0, 0, 1),
#              c(0, 0, 0))
#   rownames(X) <- c("TLS", "inflammatory","cancer","fibrotic")
#   
#   Coords.3D <- bary2cart(X,as.matrix(MarkersCellsTMENS.ct [,c("arch1","arch2","arch3","arch4")]))
#   markerCells <- MarkersCellsTMENS.ct[[marker]] #pull (MarkersCellsTMENS.ct,marker )
#   distr <- quantile(markerCells,probs = c(0,0.1,0.5,0.8,0.99))
#   if(distr[5] > min(markerCells)){
#     markerCells[markerCells>distr[5]] <- distr[5]
#   }
#   print(distr)
#   # simplex <- cbind(seq(0:1,0.001),seq(0:1,0.001),seq(0:1,0.001))
#   fig1 <- plot_ly(x = Coords.3D[,1],
#            y = Coords.3D[,2],
#            z = Coords.3D[,3],
#            type="scatter3d",
#            color = ~markerCells,
#            alpha = 0.5,
#            mode="markers",
#            name= "cells",
#            marker = list(size= 3),
#            showlegend=TRUE)%>%
#     colorbar(title = paste(marker, "in",cellType))%>%
#     add_trace(x = X[,1],
#               y = X[,2],
#               z = X[,3],
#               type = "scatter3d",mode = "markers+text",
#               marker = list(size = 8),
#               color = "red",
#               text = ~rownames(X),#c("arch. 1", "arch. 2","arch. 3","arch. 4"),#c("arch. 2", "arch. 1","arch. 3","arch. 4"),
#               textposition = c('top right','top right','bottom left','bottom left'),
#               textfont = list(color = '#000000', size = 16),
#               name = "archetypes",
#               inherit=FALSE,
#               showlegend = TRUE)%>%
#     layout(scene = list(xaxis = list(title = "x"), 
#                                        yaxis = list(title = "y"), 
#                                        zaxis = list(title = "z") ))
#   #fig1
#   return(fig1)
# }


```

```{r plotKi67, eval=FALSE,results='asis'}

plot_3D_ternary_cell_markers("Keratin-positive tumor", "Ki67")
plot_3D_ternary_cell_markers("Tumor", "Ki67")
plot_3D_ternary_cell_markers("Keratin-positive tumor","PD.L1")

```


```{r CD4Tplots,eval=FALSE,include=TRUE,results = 'asis'}

#### CD4-T
CellTypes.toPlot <- unique(selectedMarkers[["cell_type"]])
library('IRdisplay')

Markers.toPlot <-selectedMarkers%>%filter(cell_type == "CD4-T")%>%pull(marker)
PlotsList <- list()
PlotsList <- lapply(Markers.toPlot, function(marker1){
  fig <- plot_3D_ternary_cell_markers("CD4-T", marker1)
  print(htmltools::tagList(fig))
  #cat(as.character(htmltools::tagList(fig)))#,browse=TRUE
  #htmlwidgets::saveWidget(fig,"fig1.html")
  #htmltools::html_print(fig)
})

```



```{r CD8Tplots,eval=FALSE,results = 'asis'}
#### CD8-T
CellTypes.toPlot <- unique(selectedMarkers[["cell_type"]])

  Markers.toPlot <-selectedMarkers%>%filter(cell_type == "CD8-T")%>%pull(marker)
PlotsList <- list()
PlotsList <- lapply(Markers.toPlot, function(marker1){
  fig <- plot_3D_ternary_cell_markers("CD8-T", marker1)
  #cat(as.character(htmltools::tagList(fig)))#
  print(htmltools::tagList(fig))
})

#plot_3D_ternary_cell_markers("CD8-T", Markers.toPlot[1])

plot_3D_ternary_cell_markers("CD8-T","PD1")
```


### Dendritic cells

```{r DCplots,eval=FALSE,results = 'asis'}
#### DC
#CellTypes.toPlot <- unique(selectedMarkers[["cell_type"]])

Markers.toPlot <-selectedMarkers%>%filter(cell_type == "DC")%>%pull(marker)
PlotsList <- list()
PlotsList <- lapply(Markers.toPlot, function(marker1){
  fig <- plot_3D_ternary_cell_markers("DC", marker1)
  print(htmltools::tagList(fig))
})

#plot_3D_ternary_cell_markers("DC", Markers.toPlot[1])

```

```{r tregsplots,eval=FALSE,results = 'asis'}
#### Tregs
#CellTypes.toPlot <- unique(selectedMarkers[["cell_type"]])

  Markers.toPlot <-selectedMarkers%>%filter(cell_type == "Tregs")%>%pull(marker)
PlotsList <- list()
PlotsList <- lapply(Markers.toPlot, function(marker1){
  fig <- plot_3D_ternary_cell_markers("Tregs", marker1)
  print(htmltools::tagList(fig))
})

```

### Macrophages

```{r Macroplots,eval=FALSE,results = 'asis'}
#### Macrophages
#CellTypes.toPlot <- unique(selectedMarkers[["cell_type"]])

  Markers.toPlot <-selectedMarkers%>%filter(cell_type == "Macrophages")%>%pull(marker)
PlotsList <- list()
PlotsList <- lapply(Markers.toPlot, function(marker1){
  fig <- plot_3D_ternary_cell_markers("Macrophages", marker1)
  print(htmltools::tagList(fig))
})


```

### NK cells

```{r NKplots,eval=FALSE,results = 'asis'}
#### NK
#CellTypes.toPlot <- unique(selectedMarkers[["cell_type"]])

  Markers.toPlot <-selectedMarkers%>%filter(cell_type == "NK")%>%pull(marker)
PlotsList <- list()
PlotsList <- lapply(Markers.toPlot, function(marker1){
  fig <- plot_3D_ternary_cell_markers("NK", marker1)
  print(htmltools::tagList(fig))
})

#plot_3D_ternary_cell_markers("NK", Markers.toPlot[1])

```

### Neutrophils

```{r Neuplots,eval=FALSE,results = 'asis'}
#### Neutrophils
#CellTypes.toPlot <- unique(selectedMarkers[["cell_type"]])

Markers.toPlot <-selectedMarkers%>%filter(cell_type == "Neutrophils")%>%pull(marker)
PlotsList <- list()
PlotsList <- lapply(Markers.toPlot, function(marker1){
  fig <- plot_3D_ternary_cell_markers("Neutrophils", marker1)
  print(htmltools::tagList(fig))
})
#plot_3D_ternary_cell_markers("Neutrophils", "CD16")
# plot_3D_ternary_cell_markers("Neutrophils", Markers.toPlot[1])
# plot_3D_ternary_cell_markers("Neutrophils", Markers.toPlot[2])

```


### Endothelial cells

```{r Endoplots,eval=FALSE,results = 'asis'}
#### Endothelial
#CellTypes.toPlot <- unique(selectedMarkers[["cell_type"]])

  Markers.toPlot <-selectedMarkers%>%filter(cell_type == "Endothelial")%>%pull(marker)
PlotsList <- list()
PlotsList <- lapply(Markers.toPlot, function(marker1){
  fig <- plot_3D_ternary_cell_markers("Endothelial", marker1)
  print(htmltools::tagList(fig))
})

#plot_3D_ternary_cell_markers("Endothelial", Markers.toPlot[1])

```

### Other cells

```{r otherPlots,eval=FALSE, echo=TRUE}
plot_3D_ternary_cell_markers("B","CD20")
plot_3D_ternary_cell_markers("Keratin-positive tumor","EGFR")
#plot_3D_ternary_cell_markers("Tumor","EGFR")

```

## Non-linear relationship between markers and TMENs ?

## Methods

**Defining the environment of the cells.**

In order to understand how environment associates with cell phenotypes, we described the environment surrounding the cells using TMENs. Therefore, each cell will be computed the proportions of TMENs. 
We generated sites centered on cells from MIBI data. Thus, there are as many sites as cells. We computed the cell abundance across sites. We defined the proportions $\alpha$ of TMENs of a cell as is: $\rho = B \alpha$, where $\rho$ is the cell abundance in a site centered on the cell and B is the  matrix of cellular profile for each TMENs.
To find $\alpha$, we solved the equation with quadratic programming using *qpsolvers* library in Python. Cells labeled as "Unidentified" by Keren 2018 were discarded from the analysis.

**Correlations between cell phenotypes and environment.**

Having the cells and their environment ($\alpha$ for each cell), we collected the expression of protein markers cell type-wise. We selected only markers that were classified as "functional" according to [this paper](https://doi.org/10.1038/s42003-021-02361-1) (Patwa et al., Nature 2021). Cell phenotypes were defined as the expression of a marker in a cell type. We computed Spearman correlations between cell phenotypes and TMENs. We included the interfaces between TMENs as the product of different combinations of TMENs: TLS x cancer, cancer x fibrotic, cancer x inflammation, TLS x fibrotic, TLS x inflammatory, fibrotic x inflammatory, TLS x inflammatory x fibrotic, TLS x cancer x fibrotic, inflammatory x fibrotic x cancer, TLS x inflammatory x cancer, TLS x inflammatory x fibrotic x cancer.
Spearman correlation test was performed with a False Discovery Rate correction of p values. We selected only significant q values ($\alpha = 0.01$) and the cell phenotypes whose correlation coefficient was higher than $0.3$ for at least one of the environments (core TMENs and interfaces). High range interfaces between TMENs ($> 2$) were excluded as they were less informative than 2-range interfaces. In total, we kept 75 correlations between cell phenotypes and 10 core and interfaces of TMENs. To correct for bleed-over, Keratin6-positive cell phenotypes that were associated with cancer and cancer-inflammatory niches interface were removed from the analysis. We filtered out beta-catenin-positive cell phenotypes as the marker used in the antibody panel was not specific to any form of the protein. These supplemental corrections led to 59 space-driven cell phenotypes. The analysis was conducted in R. 

